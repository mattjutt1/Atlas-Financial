# Atlas Financial Redis Configuration
# Optimized for the Data Platform in modular monolith architecture

# Basic Configuration
bind 0.0.0.0
port 6379
protected-mode yes
tcp-backlog 511
timeout 300
tcp-keepalive 300

# Security
requirepass ${REDIS_PASSWORD}
# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_b3a9c1f2e8d7"

# Memory Management
maxmemory 1gb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# Persistence for Atlas Financial Data
save 900 1    # Save if at least 1 key changed in 900 seconds
save 300 10   # Save if at least 10 keys changed in 300 seconds  
save 60 10000 # Save if at least 10000 keys changed in 60 seconds

# AOF Configuration for data durability
appendonly yes
appendfilename "atlas-financial.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Logging
loglevel notice
logfile "/var/log/redis/atlas-redis.log"
syslog-enabled yes
syslog-ident atlas-redis

# Performance Tuning
databases 16
latency-monitor-threshold 100
slowlog-log-slower-than 10000
slowlog-max-len 128

# Atlas Financial Specific Configuration

# Database allocation for different purposes:
# DB 0: Session storage (default)
# DB 1: Financial calculations cache
# DB 2: AI engine cache
# DB 3: GraphQL query cache
# DB 4: User preference cache
# DB 5: Market data cache
# DB 6: Temporary data
# DB 7-15: Reserved for future use

# Client Configuration
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Network Configuration
tcp-nodelay yes
repl-disable-tcp-nodelay no

# Security enhancements
protected-mode yes
port 6379

# Lua scripting
lua-time-limit 5000

# Module Configuration for Atlas Financial
# Enable modules for financial calculations if available
# loadmodule /usr/lib/redis/modules/rejson.so
# loadmodule /usr/lib/redis/modules/redistimeseries.so

# Memory optimization for financial data
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100

# Cluster configuration (for future scaling)
# cluster-enabled no
# cluster-config-file nodes-6379.conf
# cluster-node-timeout 15000

# Replication (for future HA setup)
# replicaof <masterip> <masterport>
# masterauth <master-password>
# replica-serve-stale-data yes
# replica-read-only yes

# Keyspace notifications for real-time updates
notify-keyspace-events "Ex"

# Atlas Financial specific key patterns:
# session:* - User sessions
# financial:user:* - User financial data cache
# ai:insights:* - AI generated insights cache
# market:* - Market data cache
# calc:* - Financial calculation results
# temp:* - Temporary data (TTL applied)